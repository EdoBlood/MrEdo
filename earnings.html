<!DOCTYPE html>
<html>
<head>
  <title>Your Earnings</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
</head>
<body class="p-4">
  <h2>Your Earnings</h2>
  <div id="earningsInfo" class="mb-4"></div>
  <button id="withdrawBtn" class="btn btn-primary" onclick="requestWithdrawal()" style="display:none;">Request Withdrawal</button>

  <script>
    const supabase = supabase.createClient(
      'https://exebxtduexxgckezhdky.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV4ZWJ4dGR1ZXh4Z2NrZXpoZGt5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg0NDQ4MTYsImV4cCI6MjA3NDAyMDgxNn0.Jq6TWKe53uuBFd0ECuefyluZxRCrqaAKrp6ZJu8DSbA'
    );

    async function loadEarnings() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return;

      const { data } = await supabase.from('users').select('*').eq('id', user.id).single();
      if (data) {
        const total = data.earnings || 0;
        document.getElementById('earningsInfo').innerHTML = `
          <p><strong>Email:</strong> ${data.email}</p>
          <p><strong>Total Earnings:</strong> ₦${total}</p>
          <p><strong>Referral Code:</strong> ${data.referral_code}</p>
        `;
        if (total >= 2000) {
          document.getElementById('withdrawBtn').style.display = 'inline-block';
        }
      }
    }

    async function requestWithdrawal() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return;

      await supabase.from('withdrawals').insert({
        user_id: user.id,
        status: 'Pending',
        requested_at: new Date().toISOString()
      });

      alert('Withdrawal request submitted. You’ll be contacted shortly.');
      document.getElementById('withdrawBtn').disabled = true;
    }

    loadEarnings();
  </script>
</body>
</html>
