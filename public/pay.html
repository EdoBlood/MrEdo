<!DOCTYPE html>
<html>
<head>
  <title>Pay for Quiz</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://js.paystack.co/v1/inline.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
</head>
<body class="p-4">
  <h2>Confirm Payment</h2>
  <div id="quizDetails"></div>
  <button class="btn btn-success mt-3" onclick="payWithPaystack()">Pay Now</button>

  <script>
    const supabase = supabase.createClient(
      'https://exebxtduexxgckezhdky.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV4ZWJ4dGR1ZXh4Z2NrZXpoZGt5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg0NDQ4MTYsImV4cCI6MjA3NDAyMDgxNn0.Jq6TWKe53uuBFd0ECuefyluZxRCrqaAKrp6ZJu8DSbA'
    );

    const params = new URLSearchParams(window.location.search);
    const quizId = params.get('quiz_id');
    let quizData = null;

    async function loadQuiz() {
      const { data, error } = await supabase.from('quizzes').select('*').eq('id', quizId).single();
      if (error || !data) {
        document.getElementById('quizDetails').innerHTML = `<p>Quiz not found.</p>`;
        return;
      }
      quizData = data;
      document.getElementById('quizDetails').innerHTML = `
        <p><strong>Course:</strong> ${data.name}</p>
        <p><strong>Level:</strong> ${data.level}</p>
        <p><strong>Price:</strong> â‚¦${data.price}</p>
      `;
    }

    async function payWithPaystack() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return alert("You must be logged in");

      const handler = PaystackPop.setup({
        key: 'pk_test_52ed74a381cbb454a9af8ebf79cc491a16ffe51f',
        email: user.email,
        amount: quizData.price * 100,
        currency: 'NGN',
        label: 'Edo Quiz Hub',
        metadata: {
          custom_fields: [
            {
              display_name: "User ID",
              variable_name: "user_id",
              value: user.id
            },
            {
              display_name: "Quiz ID",
              variable_name: "quiz_id",
              value: quizData.id
            }
          ]
        },
        callback: function(response) {
          alert("Payment successful! Redirecting...");
          window.location.href = `quiz.html?file=${quizData.filename}`;
        },
        onClose: function() {
          alert('Payment cancelled');
        }
      });
      handler.openIframe();
    }

    loadQuiz();
  </script>
</body>
</html>
